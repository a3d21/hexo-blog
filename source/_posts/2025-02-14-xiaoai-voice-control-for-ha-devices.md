---
title: "[智能家居]小爱语音控制HA设备"
date: 2025-02-14 16:40:03
tags: [HA, 智能家居]
---

我使用HA作为家居设备控制中枢，接入了米家、aqara homekit、美的等多个平台设备。虽然在HA自动化中可以配合工作，但我使用的小爱音箱无法语音控制非米家平台设备，操作不方便。
有什么方式可以打通实现语音控制呢。

<!-- more -->

## 接入方案
整理一下，方法有
1. Siri音箱 + homekit bridge。通过Siri语音可以控制所有HA设备了
2. 借助yeelight pro网关，虚拟米家设备和HA设备绑定
3. 米极桥方案。用米极桥做虚拟开关，和HA设备绑定
4. 中枢网关方案。用中枢网关的虚拟事件配合ha_xiaomi_home，可以通过虚拟事件传递文本信息做控制
5. 小爱音箱对话记录方案。轮询监听小爱音箱的语音文记录，解析并控制HA设备
6. 三方平台方案。将HA设备用巴法云以第三方平台方式接入米家


以上方案中，巴法云是纯软件方式，接入方式较简单，不需要额外购买设备。缺点是依赖第三方平台，可能不稳定。
我的使用场景是用小爱语音开启/关闭美的除湿机。语音跨平台操作设备频率极低，稳定性因素影响可以忽略，所以采用巴法云接入。


## 接入原理

注册bemfa账号，用bemfa打通米家和ha。

```plantuml
actor User
participant mi_home
participant bemfa
participant ha

User -> mi_home: 语音指令
mi_home -> bemfa: 控制指令
bemfa ->> ha: 消息通知(mqtt)
```

## 接入步骤

### 1 注册[巴法云](https://bemfa.com/)账号，保存**私钥**
按网页操作即可。

### 2 HA安装[bemfa集成](https://github.com/wanghuizzz/bemfa)
注意原版集成由于bemfa api更新，已不可用，需要安装[修改版](https://github.com/wanghuizzz/bemfa)。
截至 2025-02-14，修改版可正常使用。


### 3 配置bemfa集成，配置需要暴露给米家控制的设备实体
在HA设备页面增加bemfa集成，再从bemfa集成页面选择同步设备实体。
巴法云支持设备有限，一般用“开关”或“灯光”兼容性好点。

> 巴法云 支持设备
> 001	插座设备
> 002	灯泡设备
> 003	风扇设备
> 004	传感器
> 005	空调设备
> 006	开关设备
> 009	窗帘设备

配置完成后，到[bemfa控制台](https://cloud.bemfa.com/tcp/devicemqtt.html)检查是否同步创建topic成功。

### 4 米家APP第三方平台授权&同步设备
在米家APP按指引操作接入第三方平台，并同步设备。
小爱语音测试是否正常控制。
